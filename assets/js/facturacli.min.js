class Factura{constructor(id,cajero,producto,descuento,total,fechaCreacion,importe,t,idusuario,idcliente){this.id=id||null,this.cajero=cajero||"",this.idusuario=idusuario||"",this.idcliente=idcliente||"",this.descuento=descuento||0,this.producto=producto||new Array(new Array),this.total=total||"",this.fechaCreacion=fechaCreacion||null,this.importe=importe||0,this.t=t||null}}let factura=new Factura;function LoadProducto(){""!=$("#p_searh").val()&&(producto.codigoRapido=$("#p_searh").val(),producto.scancode=$("#p_searh").val(),$.ajax({type:"POST",url:"class/Producto.php",data:{action:"ReadByCode",obj:JSON.stringify(producto)}}).done(function(e){CleanCtls(),ValidateProductFac(e)}).fail(function(e){showError(e)}))}function ValidateProductFac(e){if("false"!=e){producto=JSON.parse(e)[0],producto.UltPrd=producto.codigoRapido;var repetido=!1;0!=document.getElementById("productos").rows.length&&null!=producto&&$(document.getElementById("productos").rows).each(function(i,item){if(item.childNodes[0].innerText==producto.codigoRapido){item.childNodes[3].childNodes[0].attributes[3].value=producto.cantidad;var CantAct=parseInt(item.childNodes[3].firstElementChild.value);parseInt(producto.cantidad)>CantAct?(item.childNodes[3].firstElementChild.value=parseFloat(item.childNodes[3].firstElementChild.value)+1,item.childNodes[4].firstChild.textContent="¢"+parseFloat(item.childNodes[2].firstChild.textContent.replace("¢",""))*parseFloat(item.childNodes[3].firstElementChild.value),calcTotal()):(alertSwal(producto.cantidad),$("#cant_"+producto.UltPrd).val(producto.cantidad)),repetido=!0,calcTotal()}}),0==repetido&&AgregaPrd()}else CleanCtls()}function AgregaPrd(){producto.UltPro=producto.codigoRapido;var rowNode=t.row.add([producto.id,producto.codigoRapido,producto.descripcion,"¢"+producto.precio,"1","¢"+producto.precio]).draw().node();$("td:eq(2)",rowNode).attr({id:"prec_"+producto.codigoRapido}),$("td:eq(4)",rowNode).attr({id:"impo_"+producto.codigoRapido}),$("td:eq(3) input",rowNode).attr({id:"cant_"+producto.codigoRapido,max:producto.cantidad,min:"0",step:"1",value:"1",onchage:"CalcImporte("+producto.codigoRapido+")"}),$("td:eq(3) input",rowNode).change(function(){CalcImporte(producto.codigoRapido)}),t.order([0,"desc"]).draw(),t.columns.adjust().draw(),calcTotal(),$("#open_modal_fac").attr("disabled",!1)}function CalcImporte(prd){producto.UltPrd=prd,pUnit=$(`#prec_${prd}`)[0].textContent.replace("¢",""),cant=parseInt($(`#cant_${prd}`)[0].value),cant<=parseInt($(`#cant_${prd}`)[0].attributes[3].value)?$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseFloat(cant)).toString():(alertSwal(producto.cantidad),$("#cant_"+producto.UltPrd).val($(`#cant_${prd}`)[0].attributes[3].value)),$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseInt($(`#cant_${prd}`)[0].value)).toString(),$(`#cant_${prd}`).keyup(function(e){13==e.which&&(0==cant&&(BorraRow(prd),calcTotal()),$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseInt($(`#cant_${prd}`)[0].value)).toString(),calcTotal(),$("#p_searh").focus())}),0==cant&&(BorraRow(prd),calcTotal(),$("#p_searh").focus())}function calcTotal(){var subT=0;$(document.getElementById("productos").rows)[0].childElementCount>2?($(document.getElementById("productos").rows).each(function(i,item){subT+=parseFloat(item.childNodes[4].textContent.replace("¢",""))}),$("#subtotal")[0].textContent="¢"+subT.toFixed(2),factura.descuento=$("#desc_val")[0].textContent="¢"+(subT*parseFloat($("#desc_100")[0].textContent.replace("%",""))/100).toFixed(2),factura.impuesto=$("#iv_val")[0].textContent="¢"+(subT*(parseFloat($("#iv_100")[0].textContent.replace("%",""))/100)-parseFloat($("#desc_val")[0].textContent.replace("¢",""))).toFixed(2),$("#total")[0].textContent="¢"+($("#subtotal")[0].textContent.replace("¢","")-parseFloat($("#desc_val")[0].textContent.replace("¢",""))+parseFloat($("#iv_val")[0].textContent.replace("¢",""))).toFixed(2)):($("#open_modal_fac").attr("disabled",!0),$("#subtotal")[0].textContent="¢0",$("#desc_val")[0].textContent="¢0",$("#iv_val")[0].textContent="¢0",$("#total")[0].textContent="¢0")}function BorraRow(prd){$(`#prec_${prd}`)[0].parentElement.attributes[1].value=$(`#prec_${prd}`)[0].parentElement.attributes[1].value+" selected",t.row(".selected").remove().draw(!1)}function facCard(){$("#formapago").empty();var DivCard='<div class="row">\n        <div class="col-md-4 col-md-offset-4 col-sm-offset-0 col-xs-6 col-xs-offset-0">\n            <h3 class="text-left" >Ingrese Ref.:</h3>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4">\n            <input class="input-lg valPago" type="text" onkeyup="valPago(this.value)" placeholder="Ingrese Numero Referencia" required="" minlength="5" autofocus="">\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4 col-sm-offset-0 col-xs-6 col-xs-offset-0">\n            <button type="button" onclick="CreateFact()" class="btn btn-primary procesarFac" disabled style="margin-top:10px;">Facturar</button>\n        </div>\n    </div>';$("#formapago").append(DivCard),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalFormaPago" onclick="btnFormaPago()"class="btn btn-primary">Atras</button>';$("#btn-formapago").append(DivCash)}function facCash(){$("#formapago").empty();var DivCash='<div class="row">\n        <div class="col-md-4 col-md-offset-4 col-sm-offset-0 col-xs-6 col-xs-offset-0">\n            <h3 class="text-left" >Paga con:</h3>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4">\n            <input id="pagocash" class="input-lg valPago" onkeyup="valPago(this.value)" type="text" placeholder="Ingrese Monto en Efectivo"  required="" minlength="5" autofocus="">\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4 col-sm-offset-0 col-xs-6 col-xs-offset-0">\n            <button type="button" onclick="CreateFact()" class="btn btn-primary procesarFac" disabled style="margin-top:10px;">Procesar</button>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4 col-sm-offset-0 col-xs-6 col-xs-offset-0">\n            <h3 class="text-left" id="vuelto">Su vuelto:</h3>\n        </div>\n    </div>';$("#formapago").append(DivCash),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalFormaPago" onclick="btnFormaPago()"class="btn btn-primary">Atras</button>';$("#btn-formapago").append(DivCash)}function btnFormaPago(){$("#formapago").empty();var DivCash='<div class="col-md-2"></div>\n    <div class="col-md-3" onclick="facCard()">\n        <img id="fac-ccard" src="images/credit-cards.png" class="modal-img-pago">\n        <p class="text-center">Tarjeta</p>\n    </div>\n    <div class="col-md-2"></div>\n    <div class="col-md-3" onclick="facCash()">\n        <img id="fac-cash" src="images/cash.png" class="modal-img-pago">\n        <p class="text-center">Efectivo</p>\n    </div>';$("#formapago").append(DivCash),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalPago" class="btn btn-primary" data-dismiss="modal">Atras</button>';$("#btn-formapago").append(DivCash)}function valPago(val){xPagar=parseFloat($("#total")[0].textContent.replace("¢","")),pago=parseFloat($(".valPago").val()),isNaN($(".valPago").val())?(val=val.replace(/[^0-9]/g,""),$(".valPago").val(val)):pago>=xPagar?($(".procesarFac").prop("disabled",!1),calcVuelto(pago,xPagar)):$(".procesarFac").prop("disabled",!0)}function CreateFact(){$(t.columns().data()[0]).each(function(ic,c){factura.producto[ic]=$(t.rows().data()[ic])});var miAccion=null==this.id?"Create":"Update";$.ajax({type:"POST",url:"class/Factura.php",data:{action:miAccion,obj:JSON.stringify(factura)}}).done(alertFact()).fail(function(e){producto.showError(e)}).always(function(){setTimeout('$("#btnProducto").removeAttr("disabled")',1e3),producto=new Producto,producto.ClearCtls(),producto.Read,$("#nombre").focus()})}function alertSwal(cant){swal({type:"info",title:"Oops...",text:"Cantidad Inexistente de Producto!",footer:"<h3>Cantidad maxima de producto disponble es: "+cant+"</h3>",timer:3500})}function alertFact(){swal({type:"success",text:"Factura Lista!",timer:2e3}),$(".procesarFac").prop("disabled",!0),setTimeout(function(){location.reload()},2e3)}function calcVuelto(pago,xPagar){vuelto=(pago-xPagar).toFixed(2).toString(),$("#vuelto")[0].textContent="Su cambio: "+vuelto}function showError(e){var data=JSON.parse(e.responseText);alert("ERROR")}function CleanCtls(){$("#p_searh").val("")}$(document).ready(function(){$("#open_modal_fac").attr("disabled",!0),btnFormaPago(),$("#p_searh").keyup(function(e){13==e.which&&LoadProducto(),106==e.which&&($("#p_searh")[0].value="",$("#cant_"+producto.UltPrd).focus().select())}),$("#reload").click(function(){location.reload()}),$("#open_modal_fac").click(function(){$("#total_pagar").empty(),$("#total_pagar").append("Total a Pagar: "+$("#total")[0].textContent)}),t=$("#prd").DataTable({ordering:!1,info:!1,searching:!1,language:{infoEmpty:"No hay productos agregados",emptyTable:"No hay productos agregados",search:"Buscar En Factura"},scrollY:"190px",scrollCollapse:!0,paging:!1,columnDefs:[{width:"2%",targets:0,visible:!1,searchable:!1},{width:"10%",targets:3},{width:"5%",targets:4,data:null,defaultContent:'<input class="cantidad form-control" type="number">'},{width:"10%",targets:5}]}),t.columns.adjust().draw(),$("#fecha").append(moment().format("MMM DD YYYY, h:mm:ss a"))});