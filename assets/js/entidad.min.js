class Entidad{constructor(id,nombre,idCodigoPais,idTipoIdentificacion,identificacion,nombreComercial,idProvincia,idCanton,idDistrito,idBarrio,otrasSenas,idCodigoPaisTel,numTelefono,idCodigoPaisFax,numTelefonoFax,correoElectronico,username,password,certificado,filename,filesize,filetype,estadoCertificado,pinp12,idDocumentoReferencia){this.id=id||null,this.nombre=nombre||"",this.idCodigoPais=idCodigoPais||"",this.idTipoIdentificacion=idTipoIdentificacion||"",this.identificacion=identificacion||"",this.nombreComercial=nombreComercial||"",this.idProvincia=idProvincia||null,this.idCanton=idCanton||null,this.idDistrito=idDistrito||null,this.idBarrio=idBarrio||null,this.otrasSenas=otrasSenas||null,this.idCodigoPaisTel=idCodigoPaisTel||null,this.numTelefono=numTelefono||null,this.idCodigoPaisFax=idCodigoPaisFax||null,this.numTelefonoFax=numTelefonoFax||null,this.correoElectronico=correoElectronico||null,this.username=username||null,this.password=password||null,this.certificado=certificado||null,this.filename=filename||null,this.filesize=filesize||null,this.filetype=filetype||null,this.estadoCertificado=estadoCertificado||0,this.pinp12=pinp12||null,this.idDocumentoReferencia=idDocumentoReferencia||null}get tUpdate(){return this.update="update"}get tSelect(){return this.select="select"}set viewEventHandler(_t){this.viewType=_t}get read(){var miAccion=null==this.id?"readAll":"read";"readAll"==miAccion&&0==$("#tclientefe tbody").length||$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,id:this.id}}).done(function(e){entidad.reload(e)}).fail(function(e){entidad.showError(e)})}get readProfile(){var miAccion="readProfile";$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion}}).done(function(e){entidad.showItemData(e)}).fail(function(e){entidad.showError(e)})}get APILogin(){var miAccion="APILogin";$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion}}).fail(function(e){entidad.showError(e)})}get readAllTipoIdentificacion(){var miAccion="readAllTipoIdentificacion";$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion}}).done(function(e){entidad.showList(e,$("#idTipoIdentificacion"))}).fail(function(e){entidad.showError(e)})}get readAllUbicacion(){this.idProvincia=$("#idProvincia option:selected").val()||1,this.idCanton=$("#idCanton option:selected").val()||1,this.idDistrito=$("#idDistrito option:selected").val()||1,$("#idProvincia").html(""),$("#idCanton").html(""),$("#idDistrito").html(""),$("#idBarrio").html(""),$("#idProvincia").attr("title","Cargando ..."),$("#idCanton").attr("title","Cargando ..."),$("#idDistrito").attr("title","Cargando ..."),$("#idBarrio").attr("title","Cargando ..."),$("#idProvincia").selectpicker("refresh"),$("#idCanton").selectpicker("refresh"),$("#idDistrito").selectpicker("refresh"),$("#idBarrio").selectpicker("refresh");var miAccion="readAllUbicacion";$("#btnSubmit").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,idProvincia:this.idProvincia,idCanton:this.idCanton,idDistrito:this.idDistrito}}).done(function(e){entidad.showListUbicacion(e),$("#btnSubmit").removeAttr("disabled")}).fail(function(e){entidad.showError(e)})}get readAllProvincia(){var miAccion="readAllProvincia";$("#btnSubmit").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion}}).done(function(e){entidad.showList(e,$("#idProvincia")),$("#idProvincia option[value="+entidad.idProvincia+"]").prop("selected",!0),$("#idProvincia").selectpicker("refresh"),entidad.readAllCanton}).fail(function(e){entidad.showError(e)})}get readAllCanton(){$("#idCanton").html(""),$("#idDistrito").html(""),$("#idBarrio").html(""),$("#idCanton").attr("title","Cargando ..."),$("#idDistrito").attr("title","Cargando ..."),$("#idBarrio").attr("title","Cargando ..."),$("#idCanton").selectpicker("refresh"),$("#idDistrito").selectpicker("refresh"),$("#idBarrio").selectpicker("refresh");var miAccion="readAllCanton";this.idProvincia=$("#idProvincia option:selected").val()||1,$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,idProvincia:this.idProvincia}}).done(function(e){entidad.showList(e,$("#idCanton")),$("#idCanton option[value="+entidad.idCanton+"]").prop("selected",!0),$("#idCanton").selectpicker("refresh"),entidad.readAllDistrito}).fail(function(e){entidad.showError(e)})}get readAllDistrito(){$("#idDistrito").html(""),$("#idBarrio").html(""),$("#idDistrito").attr("title","Cargando ..."),$("#idBarrio").attr("title","Cargando ..."),$("#idDistrito").selectpicker("refresh"),$("#idBarrio").selectpicker("refresh");var miAccion="readAllDistrito";this.idCanton=$("#idCanton option:selected").val()||1,$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,idCanton:this.idCanton}}).done(function(e){entidad.showList(e,$("#idDistrito")),$("#idDistrito option[value="+entidad.idDistrito+"]").prop("selected",!0),$("#idDistrito").selectpicker("refresh"),entidad.readAllBarrio}).fail(function(e){entidad.showError(e)})}get readAllBarrio(){$("#idBarrio").html(""),$("#idBarrio").attr("title","Cargando ..."),$("#idBarrio").selectpicker("refresh");var miAccion="readAllBarrio";this.idDistrito=$("#idDistrito option:selected").val()||1,$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,idDistrito:this.idDistrito}}).done(function(e){entidad.showList(e,$("#idBarrio")),$("#idBarrio option[value="+entidad.idBarrio+"]").prop("selected",!0),$("#idBarrio").selectpicker("refresh"),$("#btnSubmit").removeAttr("disabled")}).fail(function(e){entidad.showError(e)})}get save(){if(testConn.res){var miAccion=null==this.id?"create":"update";this.nombre=$("#nombre").val();var max=11111111,min=99999999;if(this.codigoSeguridad=Math.floor(-88888887*Math.random()+min),this.idCodigoPais="52",this.idTipoIdentificacion=$("#idTipoIdentificacion option:selected").val(),this.identificacion=$("#identificacion").val(),this.nombreComercial=$("#nombreComercial").val(),"null"==$("#idProvincia option:selected").val()||null==$("#idProvincia option:selected").val()||0==$("#idProvincia option:selected").val())return swal({type:"warning",title:"Ubicación...",text:"Debe seleccionar la Provincia"}),!1;if(this.idProvincia=$("#idProvincia option:selected").val(),"null"==$("#idCanton option:selected").val()||null==$("#idCanton option:selected").val()||0==$("#idCanton option:selected").val())return swal({type:"warning",title:"Ubicación...",text:"Debe seleccionar el Cantón"}),!1;if(this.idCanton=$("#idCanton option:selected").val(),"null"==$("#idDistrito option:selected").val()||null==$("#idDistrito option:selected").val()||0==$("#idDistrito option:selected").val())return swal({type:"warning",title:"Ubicación...",text:"Debe seleccionar el Cantón"}),!1;if(this.idDistrito=$("#idDistrito option:selected").val(),this.idBarrio=$("#idBarrio option:selected").val(),this.otrasSenas=$("#otrasSenas").val(),this.idCodigoPaisTel="52",this.numTelefono=$("#numTelefono").val(),this.correoElectronico=$("#correoElectronico").val(),this.username=$("#username").val(),this.password=$("#password").val(),this.pinp12=$("#pinp12").val(),this.idDocumentoReferencia=$("#idDocumentoReferencia option:selected").val(),null==this.certificado)return swal({type:"warning",title:"Cerfificado...",text:"Debe agregar el certificado"}),!1;$("#btnSubmit").attr("disabled","disabled"),$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,objC:JSON.stringify(this)}}).done(function(){null!=dz?dz.processQueue():entidad.showInfo()}).fail(function(e){entidad.showError(e)}).always(function(){$("#btnSubmit").removeAttr("disabled")})}else swal({type:"warning",title:"Conexión...",text:"Debe probar la conexión antes de guardar"})}get delete(){$.ajax({type:"POST",url:"class/entidad.php",data:{action:"delete",id:this.id}}).done(function(){swal({type:"success",title:"Eliminado!",showConfirmButton:!1,timer:1e3})}).fail(function(e){entidad.showError(e)}).always(function(){(entidad=new Entidad).read})}get deleteCertificado(){$.ajax({type:"POST",url:"class/entidad.php",data:{action:"deleteCertificado",certificado:entidad.certificado,id:entidad.id}}).done(function(){$("#filelist").html(""),entidad.certificado=null,swal({type:"success",title:"Eliminado!",showConfirmButton:!1,timer:1e3})}).fail(function(e){entidad.showError(e)})}get downloadCertificado(){$.ajax({type:"GET",url:"class/downloadCert.php",data:{action:"downloadCertificado",certificado:entidad.certificado,id:entidad.id}}).done(function(){}).fail(function(e){entidad.showError(e)})}reload(e){null==this.id?this.showAll(e):this.showItemData(e)}showListUbicacion(e){if("[]"!=e){var data=JSON.parse(e),selector;$.each(data,function(i,item){switch(i){case 0:selector=$("#idProvincia");break;case 1:selector=$("#idCanton");break;case 2:selector=$("#idDistrito");break;case 3:selector=$("#idBarrio")}selector.html(""),$.each(item,function(n,d){selector.append(`\n                        <option value=${d.id} ${0==n?"selected":""}> ${d.value}</option>\n                    `)}),selector.selectpicker("refresh")})}else swal({type:"error",title:"Oops...",text:"Algo no está bien, La lista de ubicaciones no puede ser cargada",footer:"<a href>Contacte a Soporte Técnico</a>"})}showList(e,selector){if("[]"!=e&&""!=e){var data=JSON.parse(e);selector.html(""),$.each(data,function(i,item){selector.append(`\n                    <option value=${item.id} ${0==i?"selected":""} >${item.value}</option>\n                `)}),selector.selectpicker("refresh")}else swal({type:"error",title:"Oops...",text:"Algo no está bien, La lista no puede ser cargada",footer:"<a href>Contacte a Soporte Técnico</a>"})}showInfo(){$(".close").click(),swal({type:"success",title:"Good!",showConfirmButton:!1,timer:1e3})}showError(e){var data=JSON.parse(e.responseText);swal({type:"error",title:"Oops...",text:"Algo no está bien ("+data.code+"): "+data.msg,footer:"<a href>Contacte a Soporte Técnico</a>"})}clearCtls(){$("#id").val(""),$("#nombre").val(""),$("#idCodigoPais").val(""),$("#idTipoIdentificacion option").prop("selected",!1),$("#idTipoIdentificacion").selectpicker("refresh"),$("#identificacion").val(""),$("#nombreComercial").val(""),$("#idProvincia option").prop("selected",!1),$("#idCanton option").prop("selected",!1),$("#idDistrito option").prop("selected",!1),$("#idBarrio option").prop("selected",!1),$("#otrasSenas").val(""),$("#numTelefono").val(""),$("#correoElectronico").val(""),$("#username").val(""),$("#password").val(""),$("#pinp12").val(""),$("#filelist").html(""),null!=dz&&dz.removeAllFiles()}showAll(e){var t=$("#tclientefe").DataTable();t.clear(),t.rows.add(JSON.parse(e)),t.draw()}showItemData(e){if(this.clearCtls(),"null"!=e&&""!=e){var data=JSON.parse(e);if(null==data.id)return void entidad.readAllUbicacion;if(null==data.id)return;entidad=new Entidad(data.id,data.nombre,data.idCodigoPais,data.idTipoIdentificacion,data.identificacion,data.nombreComercial,data.idProvincia,data.idCanton,data.idDistrito,data.idBarrio,data.otrasSenas,data.idCodigoPaisTel,data.numTelefono,data.idCodigoPaisFax,data.numTelefonoFax,data.correoElectronico,data.username,data.password,data.certificado,data.filename,data.filesize,data.filetype,data.estadoCertificado,data.pinp12,data.idDocumentoReferencia),$("#id").val(entidad.id),$("#nombre").val(entidad.nombre),$("#entidad").html("<h3>Registro de Contribuyente de Factura Electrónica: "+$(".call_empresa").text()+"<h3>"),$("#idCodigoPais").val(entidad.idCodigoPais),$("#idTipoIdentificacion option[value="+entidad.idTipoIdentificacion+"]").prop("selected",!0),$("#idTipoIdentificacion").selectpicker("refresh"),$("#idDocumentoReferencia option[value="+entidad.idDocumentoReferencia+"]").prop("selected",!0),$("#idDocumentoReferencia").selectpicker("refresh"),entidad.reglasTipoIdentificacion(entidad.idTipoIdentificacion),$("#identificacion").val(entidad.identificacion),$("#nombreComercial").val(entidad.nombreComercial),entidad.readAllProvincia,$("#otrasSenas").val(entidad.otrasSenas),$("#numTelefono").val(entidad.numTelefono),$("#correoElectronico").val(entidad.correoElectronico),$("#username").val(entidad.username),$("#password").val(entidad.password),$("#pinp12").val(entidad.pinp12),$("#filelist").append(`\n                <div class="btn-group">\n                    <button type="button" class="btn ${1==entidad.estadoCertificado?"btn-success":"btn-danger"}">${entidad.certificado}</button>\n                    <button type="button" class="btn ${1==entidad.estadoCertificado?"btn-success":"btn-danger"} dropdown-toggle" data-toggle="dropdown" aria-expanded="false">\n                        <span class="caret"></span>\n                         <span class="sr-only">Toggle Dropdown</span>\n                    </button>\n                    ${1==entidad.estadoCertificado?`\n                        <ul class="dropdown-menu" role="menu">\n                            <li><a id='certEliminar'>Eliminar</a></li>\n                            <li class="divider"></li>\n                            <li><a href='class/downloadCert.php?certificado=${entidad.certificado}' id='certDescargar'>Descargar</a></li>\n                        </ul>`:""}\n                </div>           \n            `).fadeIn(),0==entidad.estadoCertificado&&swal({type:"error",title:"Oops...",text:"Ha ocurrido un error al localizar el Certificado.",footer:"<a href>Contacte a Soporte Técnico</a>"}),$("#certEliminar").click(function(){swal({title:"Eliminar Certificado?",text:"Esta acción es irreversible!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",confirmButtonClass:"btn btn-success",cancelButtonClass:"btn btn-danger"}).then(result=>{result.value&&entidad.deleteCertificado})}),testConn.res=!0}else entidad.readAllUbicacion}reglasTipoIdentificacion(opt){var p,lr,ph;switch(opt){case"1":p="([0-9])",lr="9,9",ph="9 digitos, sin cero al inicio y sin guiones.";break;case"2":p="([0-9]){9,10}$",lr="10,10",ph="10 digitos y sin guiones.";break;case"3":p="([0-9]){9,10}$",lr="11,12",ph="11 o 12 digitos, sin ceros al inicio y sin guiones.";break;case"4":p="([0-9]){10,10}$",lr="10,10",ph="10 digitos y sin guiones."}$("#identificacion").attr("pattern",p),$("#identificacion").attr("data-validate-length-range",lr),$("#identificacion").attr("placeholder",ph);var validator=new FormValidator({events:["blur","input","change"]},document.forms.frm)}checkUsername(){if(""!=$("#username").val()){$("#btnSubmit").attr("disabled","disabled");var miAccion="checkUsername";this.username=$("#username").val(),$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,username:this.username}}).done(function(e){var data;0==JSON.parse(e).status?($("#checkusername").removeClass("fa-times-circle"),$("#checkusername").addClass("fa-check-circle"),$("#btnSubmit").removeAttr("disabled")):($("#checkusername").removeClass("fa-check-circle"),$("#checkusername").addClass("fa-times-circle"),$("#checkusername").text(" El contribuyente ya está registrado."))}).fail(function(e){usuario.showError(e)})}}probarConexion(showMess=!1){if(""!=$("#username").val()&&""!=$("#password").val()){var miAccion="testConnection";this.username=$("#username").val(),this.password=$("#password").val(),$.ajax({type:"POST",url:"class/entidad.php",data:{action:miAccion,username:this.username,password:this.password,correoElectronico:this.correoElectronico}}).done(function(e){"true"==e?(showMess&&swal({type:"info",title:"Conexión...",text:"Conexión Exitosa!"}),testConn.res=!0):(showMess&&swal({type:"error",title:"Conexión...",text:"Conexión Fallida, revise su usuario y contraseña de ATV.",footer:"<a href>Contacte a Soporte Técnico</a>"}),testConn.res=!1)}).fail(function(e){usuario.showError(e)})}}init(){var validator=new FormValidator({events:["blur","input","change"]},document.forms.frm);$("#frm").submit(function(e){var validatorResult;return e.preventDefault(),validator.checkAll(this).valid&&entidad.save,!1}),document.forms.frm.onreset=function(e){validator.reset()},$(function(){$(document).ajaxStart(NProgress.start).ajaxStop(NProgress.done)}),$("#idTipoIdentificacion").on("change",function(e){validator.reset(),entidad.reglasTipoIdentificacion($(this).val())}),$("#idProvincia").on("change",function(e){entidad.readAllCanton}),$("#idCanton").on("change",function(e){entidad.readAllDistrito}),$("#idDistrito").on("change",function(e){entidad.readAllBarrio}),$("#btnTest").click(function(){entidad.probarConexion(!0)}),$("#username").on("change",function(e){entidad.probarConexion()}),$("#password").on("change",function(e){entidad.probarConexion()}),$("#username").focusout(function(){}),Dropzone.options.frmLlave={init:function(){this.on("addedfile",function(file){dz=this,entidad.certificado=dz.files[0].name}),this.on("complete",function(file){"UPLOADED"!=file.xhr.response?(swal({type:"error",title:"Oops...",text:"Ha ocurrido un error al subir el Certificado.",footer:"<a href>Contacte a Soporte Técnico</a>"}),$(file.previewElement).addClass("dz-error-message"),$("#filelist").html(""),entidad.certificado=null):entidad.showInfo()}),this.on("error",function(file){swal({type:"error",title:"Oops...",text:"Certificado con error",footer:"<a href>Contacte a Soporte Técnico</a>"}),this.removeFile(file)}),this.on("canceled",function(file){swal({type:"error",title:"Oops...",text:"Certificado cancelado",footer:"<a href>Contacte a Soporte Técnico</a>"})})},autoProcessQueue:!1,acceptedFiles:"application/x-pkcs12",maxFiles:1,addRemoveLinks:!0,autoDiscover:!1},$("#btnSubmit").click(function(){$("#frm").submit()})}}var dz;let entidad=new Entidad;var testConn={aInternal:!1,aListener:function(val){},set res(val){this.aInternal=val,this.aListener(val)},get res(){return this.aInternal},registerListener:function(listener){this.aListener=listener}};testConn.registerListener(function(val){val?($("#btnTest").text("Conexión Ok!"),$("#btnTest").attr("class","btn btn-success")):($("#btnTest").text("Probar Conexión"),$("#btnTest").attr("class","btn btn-danger"))});